<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ag-grid-community/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ag-grid-community/styles/ag-theme-alpine.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ag-grid-community/core/dist/ag-grid-community.noStyle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        img{
            height: 120px;
            padding: 2%;
        }
        .red-text {
    background-color: red;
    color: white; /* белый текст на красном фоне */
    padding: 2px 5px; /* отступы вокруг текста */
    border-radius: 3px; /* скругление углов */
}

.orange-text {
    background-color: orange;
    color: black; /* черный текст на оранжевом фоне */
    padding: 2px 5px;
    border-radius: 3px;
}

.yellow-text {
    background-color: yellow;
    color: black;
    padding: 2px 5px;
    border-radius: 3px;
}

.green-text {
    background-color: green;
    color: white;
    padding: 2px 5px;
    border-radius: 3px;
}

    </style>
</head>
<body>
    <div class="table-wrapper">
        <div class="headerContainer">
            <div class="input-group">
                <input type="number" id="daysInput" class="form-control" placeholder="Введите количество дней"
                    aria-label="Введите количество дней от 15 до 45" aria-describedby="basic-addon2" min="15" max="45">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary calculateReplenishment" type="button">Рассчитать пополнение (шт)</button>
                </div>
            </div>
            <button class="btn btn-outline-secondary deleteModify" type="button">Показать товар без модификаций</button>
            <button class="btn btn-outline-secondary reloadData" type="button">Обновить данные</button>
        </div>
        <div style="margin-bottom: 10px;">
            <button id="resetFilters">Сбросить все фильтры</button>
        </div>
        <div class="table-inner container mt-4">
            <div id="myGrid" class="ag-theme-alpine" style="height: 600px; width: 100%;"></div>
            <div id="loading" style="display: none;">Загрузка...</div>
        </div>
    </div>

    <script>
     // Определение столбцов и параметров сетки
const columnDefs = [
    { headerName: '№', valueGetter: 'node.rowIndex + 1', width: 70, sortable: false, filter: false },
    { headerName: 'Фото', field: 'photo', cellRenderer: params => `<img src="${params.value}">` },
    { headerName: 'Предмет', field: 'subjectName' },
    { headerName: 'Номенклатура', field: 'nmID' },
    { headerName: 'Размер', field: 'size' },
    { headerName: 'Заказы 1м', field: 'orders1m' },
    { headerName: 'Заказы 14 д', field: 'orders14d' },
    { headerName: 'График продаж за месяц', field: 'salesGraph',  width: 250, cellRenderer: params => createSalesGraph(params.data.salesGraph) },
    {
        headerName: 'Остаток (шт)',
        field: 'stock',
        cellRenderer: function(params) {
            const value = params.value;
            let className = '';
            if (value >= 0 && value <= 1.99) {
                className = 'red-text';
            } else if (value >= 2 && value <= 5.99) {
                className = 'orange-text';
            } else if (value >= 6 && value <= 10.99) {
                className = 'yellow-text';
            } else if (value >= 11) {
                className = 'green-text';
            }

            return `<span class="${className}">${value}</span>`;
        }
    },
    {
        headerName: 'Остаток (дн)',
        field: 'stockDays',
        cellRenderer: function(params) {
            const value = params.value;
            let className = '';
            if (value >= 0 && value <= 1.99) {
                className = 'red-text';
            } else if (value >= 2 && value <= 5.99) {
                className = 'orange-text';
            } else if (value >= 6 && value <= 10.99) {
                className = 'yellow-text';
            } else if (value >= 11) {
                className = 'green-text';
            }

            return `<span class="${className}">${value}</span>`;
        }
    },
    { headerName: 'Пополнить (шт)', field: 'replenish' },
    { headerName: 'Артикул', field: 'vendorCode' }
];

const localeText = {
    // Русификация фильтров
    page: 'страница',
    more: 'ещё',
    to: 'к',
    of: 'из',
    next: 'следующий',
    last: 'последний',
    first: 'первый',
    previous: 'предыдущий',
    loadingOoo: 'Загрузка...',
    applyFilter: 'Применить фильтр...',
    equals: 'Равно',
    notEqual: 'Не равно',
    filterOoo: 'Фильтр...',
    contains: 'Содержит',
    notContains: 'Не содержит',
    startsWith: 'Начинается с',
    endsWith: 'Заканчивается на',
    andCondition: 'И',
    orCondition: 'Или'
};

const gridOptions = {
    enableCellTextSelection: true,
    columnDefs: columnDefs,
    defaultColDef: {
        sortable: true,
        filter: true,
        resizable: true
    },
    rowData: [],
    localeText: localeText,
    rowHeight: 120,
  
};

// Функция для преобразования данных
function transformData(data) {
    let transformedData = [];
    data.forEach(item => {
        item.allowed_sizes.forEach(size => {
            let stock = item.stocks ? item.stocks[size] || 0 : 0;
            let orders1m = item["30midle_sales"] ? item["30midle_sales"][size] || 0 : 0;
            let stockDays = orders1m !== 0 ? parseFloat((stock / orders1m).toFixed(2)) : 0;
            console.log(typeof(stockDays));

            transformedData.push({
                photo: item.photos ? item.photos[0]["c516x688"] : '',
                subjectName: item.subjectName,
                nmID: item.nmID,
                size: size,
                orders1m: orders1m,
                orders14d: item["14midle_sales"] ? item["14midle_sales"][size] || 0 : 0,
                salesGraph: item["30stat"], // Данные для графика,
                stock: stock,
                stockDays: stockDays,
                replenish: '',
                vendorCode: item.vendorCode
            });
        });
    });
    return transformedData;
}

// Функция для преобразования данных без размеров
function transformDataWithoutSizes(data) {
    let transformedData = [];
    data.forEach(item => {
        let totalStock = 0;
        let totalOrders1m = 0;
        let totalOrders14d = 0;

        item.allowed_sizes.forEach(size => {
            totalStock += item.stocks ? item.stocks[size] || 0 : 0;
            totalOrders1m += item["30midle_sales"] ? item["30midle_sales"][size] || 0 : 0;
            totalOrders14d += item["14midle_sales"] ? item["14midle_sales"][size] || 0 : 0;
        });

        transformedData.push({
            photo: item.photos ? item.photos[0].c246x328 : '', // Убедитесь, что добавили поле photos в данные
            subjectName: item.subjectName,
            nmID: item.nmID,
            size: '-', // Прочерк для размера
            orders1m: totalOrders1m,
            orders14d: totalOrders14d,
            salesGraph: item["30stat"], // Данные для графика
            stock: totalStock,
            stockDays: '', // Оставляем пустым или рассчитаем по новой логике
            replenish: '',
            vendorCode: item.vendorCode
        });
    });
    return transformedData;
}

// Функция для получения данных
function fetchData() {
    $.getJSON('data.json', function (response) {
        const originalData = response.data;
        const rowData = transformData(originalData);
        console.log(rowData);
        gridOptions.api.applyTransaction({ add: rowData });
    }).fail(function () {
        console.error('Ошибка при загрузке данных');
    });
}


// График на 30 дней
function createSalesGraph(statData) {
    const canvasId = `chart-${Math.random().toString(36).substr(2, 9)}`;
    setTimeout(() => {
        const ctx = document.getElementById(canvasId).getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: Object.keys(statData),
                datasets: [{
                    label: 'Продажи',
                    data: Object.values(statData),
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    pointRadius: 0,
                    borderWidth: 1, // Устанавливаем толщину линии
                    pointHoverRadius: 5, // Радиус точки при наведении
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        display: true, // Отображение оси X
                        ticks: {
                            display: false // Скрываем метки по оси X
                        }
                    },
                    y: {
                        display: true, // Отображение оси Y
                        ticks: {
                            display: false // Скрываем метки по оси Y
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false // Убираем легенду
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `Дата: ${context.label}, Количество: ${context.parsed.y}`;
                            }
                        }
                    },
                    hover: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                elements: {
                    point: {
                        radius: 0, // Скрываем точки
                        hoverRadius: 5, // Радиус точки при наведении
                        hitRadius: 10, // Радиус области взаимодействия точки
                    }
                }
            }
        });
    }, 100);
    return `<canvas id="${canvasId}" style="width: 100%; height: 100px;"></canvas>`;
}


// Обработчик кнопки "Показать товар без модификаций"
document.querySelector('.deleteModify').addEventListener('click', function () {
    $.getJSON('data.json', function (response) {
        const originalData = response.data;
        const rowDataWithoutSizes = transformDataWithoutSizes(originalData);
        gridOptions.api.setRowData(rowDataWithoutSizes);
    }).fail(function () {
        console.error('Ошибка при загрузке данных');
    });
});

document.addEventListener('DOMContentLoaded', function () {
    const gridDiv = document.querySelector('#myGrid');
    new agGrid.Grid(gridDiv, gridOptions);

    fetchData();

    // Добавление события для кнопки сброса всех фильтров
    document.querySelector('#resetFilters').addEventListener('click', function() {
        gridOptions.api.setFilterModel(null);
    });
 
 
    // Обработчик кнопки "Рассчитать пополнение (шт)"
 document.querySelector('.calculateReplenishment').addEventListener('click', function () {
    console.log('work');
        const daysInput = document.querySelector('#daysInput').value;
        if (isNaN(daysInput) || daysInput < 15 || daysInput > 45) {
            alert('Введите число в диапазоне от 15 до 45');
        } 
        // Проверяем, что daysInput не пустой и является числом
        if (daysInput && !isNaN(daysInput)) {
            // Рассчитываем replenish для каждой строки
            gridOptions.api.forEachNode(rowNode => {
                const orders1m = rowNode.data.orders1m;
                const stockDays = rowNode.data.stockDays;

                if (orders1m !== 0 && stockDays !== 0) {
                    let replenish = ((orders1m * daysInput) - stockDays).toFixed(2);

                    console.log('replenish: ',replenish);
                    
                    // if(replenish < 1){
                    //     replenish=Number(1)
                    // }
                   
                    // Обновляем данные в текущей строке
                    rowNode.setDataValue('replenish', replenish);
                }
            });
        } else {
            console.error('Введите корректное значение для количества дней');
        }
    });
    
});


    </script>
</body>
</html>
