<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ag-grid-community/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ag-grid-community/styles/ag-theme-alpine.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ag-grid-community/core/dist/ag-grid-community.noStyle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        img{
            height: 120px;
            padding: 2%;
        }
        .red-text {
    background-color: red;
    color: white; /* белый текст на красном фоне */
    padding: 2px 5px; /* отступы вокруг текста */
    border-radius: 3px; /* скругление углов */
}

.orange-text {
    background-color: orange;
    color: black; /* черный текст на оранжевом фоне */
    padding: 2px 5px;
    border-radius: 3px;
}

.yellow-text {
    background-color: yellow;
    color: black;
    padding: 2px 5px;
    border-radius: 3px;
}

.green-text {
    background-color: green;
    color: white;
    padding: 2px 5px;
    border-radius: 3px;
}
.table-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
            width: 100vw;
            align-items: center;
        }
        .headerContainer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            width: 80vw;
        }
        .input-group,.btn-wrapper{
            height: 50px;
        }
        input, button{
            height: 100% !important;
            font-size: small !important;
        }
        .input-group{
            width: 40vw !important;
        }
        .table-inner {
          
            width: 100%;
        }
        #myGrid {
            /* height: calc(100% - 50px); */
            width: 100%;
        }
        #loading {
            text-align: center;
            padding: 20px;
            font-size: 1.5rem;
        }
        #resetFilters {
            margin-bottom: 10px;
        }


    </style>
</head>
<body>
    <div class="table-wrapper">
        <div class="headerContainer">
            <div class="input-group">
                <input type="number" id="daysInput" class="form-control" placeholder="Введите количество дней"
                    aria-label="Введите количество дней от 15 до 45" aria-describedby="basic-addon2" min="15" max="45">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary calculateReplenishment" type="button">Рассчитать пополнение (шт)</button>
                </div>
            </div>
            <div class="btn-wrapper"> <button id="resetFilters" class="btn btn-outline-secondary ">Сбросить все фильтры</button> </div>
            <div class="btn-wrapper"> <button class="btn btn-outline-secondary deleteModify" type="button">Показать товар без модификаций</button></div>
            
           
        </div>
        
        <div class="table-inner container mt-4">
            <div id="myGrid" class="ag-theme-alpine" style="height: 600px"></div>
            <div id="loading" style="display: none;">Загрузка...</div>
        </div>
    </div>

    <script>
     // Определение столбцов и параметров сетки
const columnDefs = [
    { headerName: '№', valueGetter: 'node.rowIndex + 1', width: 60, sortable: false, filter: false },
    { headerName: 'Фото', field: 'photo', width: 100, cellRenderer: params => `<img src="${params.value}">` },
    { headerName: 'Предмет', field: 'subjectName', width: 120 },
    { headerName: 'Номенклатура', field: 'nmID', width: 160 },
    { headerName: 'Размер', field: 'size', width: 120 },
    { headerName: 'Заказы 1м', field: 'orders1m', width: 150 },
    { headerName: 'Заказы 14 д', field: 'orders14d', width: 150 },
    // { headerName: 'График продаж за месяц', field: 'salesGraph', width: 250, cellRenderer: params => createSalesGraph(params.data.salesGraph) },
    // { headerName: 'Сравнение продаж (нед)', field: 'compareGraph', width: 250, cellRenderer: params => createCompareGraph(params.data.graph) },
    {
        headerName: 'Графики',
        field: 'graph',
        width: 300,
        cellRenderer: params => createToggleableGraph(params)
    },
    {
        headerName: 'Остаток (шт)',
        field: 'stock',
        width: 120,
        cellRenderer: function(params) {
            const value = params.value;
            let className = '';
            if (value >= 0 && value <= 1.99) {
                className = 'red-text';
            } else if (value >= 2 && value <= 5.99) {
                className = 'orange-text';
            } else if (value >= 6 && value <= 10.99) {
                className = 'yellow-text';
            } else if (value >= 11) {
                className = 'green-text';
            }

            return `<span class="${className}">${value}</span>`;
        }
    },
    {
        headerName: 'Остаток (дн)',
        field: 'stockDays',
        width: 120,
        cellRenderer: function(params) {
            const value = params.value;
            let className = '';
            if (value >= 0 && value <= 1.99) {
                className = 'red-text';
            } else if (value >= 2 && value <= 5.99) {
                className = 'orange-text';
            } else if (value >= 6 && value <= 10.99) {
                className = 'yellow-text';
            } else if (value >= 11) {
                className = 'green-text';
            }

            return `<span class="${className}">${value}</span>`;
        }
    },
    { headerName: 'Пополнить (шт)', field: 'replenish',width: 120 },
    { headerName: 'Артикул', field: 'vendorCode', width: 150, }
];


const localeText = {
    // Русификация фильтров
    page: 'страница',
    more: 'ещё',
    to: 'к',
    of: 'из',
    next: 'следующий',
    last: 'последний',
    first: 'первый',
    previous: 'предыдущий',
    loadingOoo: 'Загрузка...',
    applyFilter: 'Применить фильтр...',
    equals: 'Равно',
    notEqual: 'Не равно',
    filterOoo: 'Фильтр...',
    contains: 'Содержит',
    notContains: 'Не содержит',
    startsWith: 'Начинается с',
    endsWith: 'Заканчивается на',
    andCondition: 'И',
    orCondition: 'Или'
};



const gridOptions = {
    enableCellTextSelection: true,
    columnDefs: columnDefs,
    defaultColDef: {
        sortable: true,
        filter: true,
        resizable: true
    },
    rowData: [],
    localeText: localeText,
    rowHeight: 120,
    getRowId: params => {
        const id = params.data.uniqueId;
        // console.log('Row ID:', id, 'Data:', params);
        return id;
    }
};

// !!! УБРАТЬ при подключении АПИ Функция для загрузки данных и отображения таблицы 
function fetchData() {
    $.getJSON('data.json', function (response) {
        const originalData = response.data;
        const rowData = transformData(originalData);
        // console.log('rowData ',rowData);
        gridOptions.api.applyTransaction({ add: rowData });
    }).fail(function () {
        console.error('Ошибка при загрузке данных');
    });
}

// !!! РАССКОММЕНТИРОВАТЬ при загрузке данных с сервере
// function fetchData() {
//     $.ajax({
//         url: '/api/get_stat_table',
//         method: 'GET',
//         dataType: 'json',
//         success: function (response) {
//             const originalData = response.data;
//             const rowData = transformData(originalData);
//             gridOptions.api.applyTransaction({ add: rowData });
//         },
//         error: function () {
//             console.error('Ошибка при загрузке данных');
//         }
//     });
// }


// Функция для преобразования данных
function transformData(data) {
    let transformedData = [];
    data.forEach(item => {
        item.allowed_sizes.forEach(size => {
            let stock = item.stocks ? item.stocks[size] || 0 : 0;
            let orders1m = item["30midle_sales"] ? item["30midle_sales"][size] || 0 : 0;
            let stockDays = orders1m !== 0 ? parseFloat((stock / orders1m).toFixed(2)) : 0;

            // Создаем уникальный идентификатор на основе генератора
            let uniqueId = `${item.nmID}-${size}`;
            // console.log('uniqueId в начале' , uniqueId);
            // console.log('Transformed uniqueId:', uniqueId);
            //  console.log('item.graph в transformData:', item.graph );
            transformedData.push({
                uniqueId: uniqueId, // Добавляем уникальный идентификатор
                photo: item.photos ? item.photos[0]["c516x688"] : '',
                subjectName: item.subjectName,
                nmID: item.nmID,
                size: size,
                orders1m: orders1m,
                orders14d: item["14midle_sales"] ? item["14midle_sales"][size] || 0 : 0,
                salesGraph: item["30stat"], // Данные для графика,
                graph: item.graph ,// Данные для сравнения графиков продаж
                stock: stock,
                stockDays: stockDays,
                replenish: '',
                vendorCode: item.vendorCode
            });
        });
    });
    return transformedData;
}

// Функция для преобразования данных без размеров
function transformDataWithoutSizes(data) {
    let transformedData = [];
    data.forEach(item => {
        let totalStock = 0;
        let totalOrders1m = 0;
        let totalOrders14d = 0;
        
        //  console.log('item.graph в transformDataWithoutSizes',item.graph);

        item.allowed_sizes.forEach(size => {
            totalStock += item.stocks ? item.stocks[size] || 0 : 0;
            totalOrders1m += item["30midle_sales"] ? item["30midle_sales"][size] || 0 : 0;
            totalOrders14d += item["14midle_sales"] ? item["14midle_sales"][size] || 0 : 0;
        });

        let stockDays = totalOrders1m !== 0 ? parseFloat((totalStock / totalOrders1m).toFixed(2)) : 0;
let orders1m  = parseFloat(totalOrders1m.toFixed(2))
let orders14d  = parseFloat(totalOrders14d.toFixed(2))
        let uniqueId = item.nmID;
        // console.log('uniqueId во второй' , uniqueId);
        transformedData.push({
            uniqueId: uniqueId, // Добавляем уникальный идентификатор
            photo: item.photos ? item.photos[0].c246x328 : '',
            subjectName: item.subjectName,
            nmID: item.nmID,
            size: '-', // Прочерк для размера
            orders1m: orders1m,
            orders14d: orders14d,
            salesGraph: item["30stat"],
            graph: item.graph, 
            stock: totalStock,
            stockDays: stockDays, //  добавить логику для расчета
            replenish: '',
            vendorCode: item.vendorCode
        });
    });
    return transformedData;
}

//переключаем графики
function createToggleableGraph(params) {
    const container = document.createElement('div');
    let currentGraph = 'compareGraph'; 

    function toggleGraph() {
        currentGraph = currentGraph === 'compareGraph' ? 'salesGraph' : 'compareGraph';
        const graphData = currentGraph === 'compareGraph' ? params.data.graph : params.data.salesGraph;
        container.innerHTML = createGraphComponent(graphData);
    }

    function createGraphComponent(graphData) {
        if (currentGraph === 'compareGraph') {
            return createCompareGraph(graphData);
        } else {
            return createSalesGraph(graphData);
        }
    }

    container.innerHTML = createGraphComponent(params.data.graph);
    container.addEventListener('click', toggleGraph);

    return container;
}

// График на 30 дней
function createSalesGraph(statData) {
    const canvasId = `chart-${Math.random().toString(36).substr(2, 9)}`;
    setTimeout(() => {
        const ctx = document.getElementById(canvasId).getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: Object.keys(statData),
                datasets: [{
                    label: 'Продажи',
                    data: Object.values(statData),
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    pointRadius: 0,
                    borderWidth: 1, // Устанавливаем толщину линии
                    pointHoverRadius: 5, // Радиус точки при наведении
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        display: true, // Отображение оси X
                        ticks: {
                            display: false // Скрываем метки по оси X
                        }
                    },
                    y: {
                        display: true, // Отображение оси Y
                        ticks: {
                            display: false // Скрываем метки по оси Y
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false // Убираем легенду
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `Дата: ${context.label}, Количество: ${context.parsed.y}`;
                            }
                        }
                    },
                    hover: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                elements: {
                    point: {
                        radius: 0, // Скрываем точки
                        hoverRadius: 5, // Радиус точки при наведении
                        hitRadius: 10, // Радиус области взаимодействия точки
                    }
                }
            }
        });
    }, 100);
    return `<canvas id="${canvasId}" style="width: 100%; height: 100px;"></canvas>`;
}

function createCompareGraph(graphData) {

     console.log('graphData: ', graphData);
    const canvasId = `compare-chart-${Math.random().toString(36).substr(2, 9)}`;
    const daysOfWeek = ["Вс", "Пн", "Вт", "Ср", "Чт", "Пт", "Сб"]; // индексы этих дней: 0,1,2,3,4,5,6
        const currentDate = new Date();
        const currentDayIndex = currentDate.getDay(); // нашли индекс текущего дня

        // меняем массив дней недели так, чтобы справа был текущий день недели
        const labels = [...daysOfWeek.slice(currentDayIndex + 1), ...daysOfWeek.slice(0, currentDayIndex + 1)];

        const currentWeekData = new Array(7).fill(0); // Продажи текущей недели
        const previousWeekData = new Array(7).fill(0); // Продажи предыдущей 

        // меняем строку даты в объект Date
        const parseDate = (dateString) => {
            const [day, month, year] = dateString.split('.').map(num => parseInt(num, 10));
            return new Date(`20${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`);
        };

        // Функция для получения индекса дня недели
        const getWeekdayIndex = (date) => {
            return date.getDay();
        };

        // Заполняем данные продаж для текущей и предыдущей недели
        for (const [dateString, count] of Object.entries(graphData)) {
            const date = parseDate(dateString);
            const dayDiff = Math.floor((currentDate - date) / (1000 * 60 * 60 * 24));
            if (dayDiff >= 0 && dayDiff < 7) {
                currentWeekData[(7 + getWeekdayIndex(date) - currentDayIndex - 1) % 7] = count;
            } else if (dayDiff >= 7 && dayDiff < 14) {
                previousWeekData[(7 + getWeekdayIndex(date) - currentDayIndex - 1) % 7] = count;
            }
        }

    setTimeout(() => {
        const ctx = document.getElementById(canvasId).getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Продажи предыдущей недели', // убрал это обозначение
                    data: previousWeekData,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }, {
                    label: 'Продажи текущей недели', // убрал это обозначение
                    data: currentWeekData,
                    backgroundColor: 'rgba(153, 102, 255, 0.6)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        display: false // Скрыть ось Y
                    },
                    x: {
                        display: true,
                        ticks: {
                            color: 'grey' // Цвет текста на оси X
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false // Скрыть легенду
                    },
                    tooltip: {
                        enabled: true,
                        callbacks: {
                            label: function (tooltipItem) {
                                let label = tooltipItem.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += tooltipItem.raw.toFixed(2);
                                return label;
                            }
                        }
                    }
                },
                maintainAspectRatio: false,
                responsive: true
            }
        });
    }, 100);

    return `<canvas id="${canvasId}" style="width: 100%; height: 100px;"></canvas>`;
}
     

// Обработчик кнопки "Показать товар без модификаций" НЕ РАБОТАЕТ ХЗ ПОЧЕМУ
document.querySelector('.deleteModify').addEventListener('click', function () {
    if ($(this).text() === "Показать товар без модификаций") {   
        $(this).text("Показать модификации");   
        $.getJSON('data.json', function (response) {
            const originalData = response.data;
            const rowDataWithoutSizes = transformDataWithoutSizes(originalData);

            // console.log('originalData:', originalData);

            // console.log('rowDataWithoutSizes:', rowDataWithoutSizes);


            // Применяем транзакцию для удаления текущих данных и добавления новых данных без размеров
            const nodesToRemove = [];
            gridOptions.api.forEachNode(node => {
                nodesToRemove.push(node.data);
            });

            gridOptions.api.applyTransaction({
                remove: nodesToRemove,
                add: rowDataWithoutSizes
            });
        }).fail(function () {
            console.error('Ошибка при загрузке данных');
        });
       
    } else if ($(this).text() === "Показать модификации") {
         $(this).text("Показать товар без модификации");      
        //  // Загружаем и отображаем модификации
        //  $.getJSON('data.json', function (response) {
        //     const originalData = response.data;
        //     const modifiedData = transformData(originalData);

        //     gridOptions.api.applyTransaction({
        //         remove: [], // При смене данных не удаляем текущие, только добавляем новые
        //         add: modifiedData
        //     });
        // }).fail(function () {
        //     console.error('Ошибка при загрузке данных');
        // });
        location.reload()
    }
    
});



// Добавление события для кнопки сброса всех фильтров
document.querySelector('#resetFilters').addEventListener('click', function() {
    // console.log('work');
        gridOptions.api.setFilterModel(null);
        
    });
 
 
// Обработчик кнопки "Рассчитать пополнение (шт)"
document.querySelector('.calculateReplenishment').addEventListener('click', function () {
    const daysInputElement = document.querySelector('#daysInput');
    const daysInput = daysInputElement.value;

    if (isNaN(daysInput) || daysInput < 15 || daysInput > 45) {
        alert('Введите число в диапазоне от 15 до 45');
    } 

    // Проверяем, что daysInput не пустой и является числом
    if (daysInput && !isNaN(daysInput)) {
        // Рассчитываем replenish для каждой строки
        gridOptions.api.forEachNode(rowNode => {
            const orders1m = rowNode.data.orders1m;
            const stockDays = rowNode.data.stockDays;

            if (orders1m !== 0 && stockDays !== 0) {
                let replenish = ((orders1m * daysInput) - stockDays).toFixed(2);

                // Обновляем данные в текущей строке
                rowNode.setDataValue('replenish', replenish);
            }
        });

        // Очищаем значение инпута после выполнения расчетов
        daysInputElement.value = '';
    } else {
        console.error('Введите корректное значение для количества дней');
    }
});

    
document.addEventListener('DOMContentLoaded', function () {
    const gridDiv = document.querySelector('#myGrid');
    new agGrid.Grid(gridDiv, gridOptions);

    fetchData();

    
    
});


    </script>
</body>
</html>
