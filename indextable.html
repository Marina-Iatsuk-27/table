<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ag-grid-community/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ag-grid-community/styles/ag-theme-alpine.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ag-grid-community/core/dist/ag-grid-community.noStyle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ag-grid-enterprise/charts/dist/ag-charts-community.min.noStyle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="table-wrapper">
        <div class="headerContainer">
            <div class="input-group">
                <input type="number" id="daysInput" class="form-control" placeholder="Введите количество дней"
                    aria-label="Введите количество дней от 15 до 45" aria-describedby="basic-addon2" min="15" max="45">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary calculateReplenishment" type="button">Рассчитать пополнение (шт)</button>
                </div>
            </div>
            <button class="btn btn-outline-secondary deleteModify" type="button">Показать товар без модификаций</button>
            <button class="btn btn-outline-secondary reloadData" type="button">Обновить данные</button>
        </div>

        <div class="table-inner container mt-4">
            <div id="myGrid" class="ag-theme-alpine" style="height: 600px; width: 100%;"></div>
            <div id="loading" style="display: none;">Загрузка...</div>
        </div>
    </div>

    <script>
        function fetchData() {
            $.getJSON('data.json', function (response) {
                originalData = response.data;
                console.log(originalData);
                sessionStorage.setItem('data', JSON.stringify(originalData));
              
            }).fail(function () {
                console.error('Ошибка при загрузке данных');
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            fetchData();
            const gridDiv = document.querySelector('#myGrid');
            
            new agGrid.Grid(gridDiv, gridOptions);
            
        });
    
        let gridOptions = {
    columnDefs: [
        { headerName: 'Фото', field: 'photos', cellRenderer: renderPhoto, width: 100 },
        { headerName: 'Предмет', field: 'subjectName', filter: true, valueFormatter: formatValue },
        { headerName: 'Номенклатура', field: 'nmID', filter: true, valueFormatter: formatValue },
        { headerName: 'Размер', field: 'allowed_sizes', filter: true, valueFormatter: formatValue },
        { headerName: 'Заказы 1м', field: 'orders30', filter: true, valueFormatter: formatValue },
        { headerName: 'Заказы 14 д', field: 'orders14', filter: true, valueFormatter: formatValue },
        { headerName: 'График продаж', field: 'graph', cellRenderer: renderChart },
        { headerName: 'Остаток (шт)', field: 'leftovers', filter: true, cellClass: 'leftovers-cell', valueFormatter: formatValue },
        { headerName: 'Остаток (дн)', field: 'leftoversDays', filter: true, cellClass: 'leftovers-days-cell', valueFormatter: formatValue },
        { headerName: 'Пополнить (шт)', field: 'replenishment', valueFormatter: formatValue },
        { headerName: 'Артикул', field: 'vendorCode', filter: true, valueFormatter: formatValue }
    ],
    defaultColDef: {
        sortable: true,
        flex: 1,
        minWidth: 100,
        valueFormatter: formatValue
    }
};



function formatValue(params) {
    console.log('Value in formatValue function:', params.value);

    if (params.value === undefined || params.value === null) {
        return '0'; // Устанавливаем значение '0' для пустых или неопределенных значений
    } else if (Array.isArray(params.value)) {
        return params.value.join(', '); // Преобразуем массивы в строку с разделителями
    } else if (typeof params.value === 'object') {
        return JSON.stringify(params.value); // Преобразуем объекты в JSON строку
    } else {
        return params.value.toString(); // Преобразуем все остальные типы данных в строковое представление
    }
}







       
    
        function renderTable(data) {
            let formattedData = [];
    
            data.forEach(item => {
                item.allowed_sizes.forEach(size => {
                    let formattedItem = { ...item };
                    formattedItem.size = size;
                    formattedItem.orders30 = parseFloat(item['30midle_sales'][size]) || 0;
                    formattedItem.orders14 = parseFloat(item['14midle_sales'][size]) || 0;
                    formattedItem.leftovers = parseFloat(item['stocks'][size]) || 0;
                    formattedItem.leftoversDays = formattedItem.orders30 === 0 ? 0 : (formattedItem.leftovers / formattedItem.orders30).toFixed(2);
                    formattedItem.replenishment = 'Введите кол-во дней в форму выше и рассчитайте';
                    formattedData.push(formattedItem);
                });
            });
    
            gridOptions.api.applyTransaction({ add: formattedData });
        }
    
        function renderPhoto(params) {
            // return params.value ? `<img src="${params.value[0].c246x328}" alt="Фото">` : '';
            return '';
        }
    
        function renderChart(params) {
            // const canvasId = `${params.data.nmID}-${params.data.size}`;
            // const graphData = params.value;
            // setTimeout(() => initializeChart(canvasId, graphData), 0);
            // return `<div class="chart-container"><canvas id="${canvasId}" style="display: block; box-sizing: border-box;"></canvas></div>`;
            return '';
        }
    
        function initializeChart(canvasId, graphData) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const daysOfWeek = ["Вс", "Пн", "Вт", "Ср", "Чт", "Пт", "Сб"];
            const currentDate = new Date();
            const currentDayIndex = currentDate.getDay();
    
            const labels = [...daysOfWeek.slice(currentDayIndex + 1), ...daysOfWeek.slice(0, currentDayIndex + 1)];
    
            const currentWeekData = new Array(7).fill(0);
            const previousWeekData = new Array(7).fill(0);
    
            const parseDate = (dateString) => {
                const [day, month, year] = dateString.split('.').map(num => parseInt(num, 10));
                return new Date(`20${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`);
            };
    
            const getWeekdayIndex = (date) => date.getDay();
    
            for (const [dateString, count] of Object.entries(graphData)) {
                const date = parseDate(dateString);
                const dayDiff = Math.floor((currentDate - date) / (1000 * 60 * 60 * 24));
                if (dayDiff >= 0 && dayDiff < 7) {
                    currentWeekData[(7 + getWeekdayIndex(date) - currentDayIndex - 1) % 7] = count;
                } else if (dayDiff >= 7 && dayDiff < 14) {
                    previousWeekData[(7 + getWeekdayIndex(date) - currentDayIndex - 1) % 7] = count;
                }
            }
    
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Продажи предыдущей недели',
                        data: previousWeekData,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Продажи текущей недели',
                        data: currentWeekData,
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'grey'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'grey'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: 'grey'
                            }
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: function (tooltipItem) {
                                    let label = tooltipItem.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += tooltipItem.raw.toFixed(2);
                                    return label;
                                }
                            }
                        }
                    },
                    maintainAspectRatio: false,
                    responsive: true
                }
            });
        }
    </script>
    
    
</body>
</html>